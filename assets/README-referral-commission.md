## Is the referral bonus calculated immediately after a user registers?
In most MLM (Multi-Level Marketing) systems, referral bonus is not immediately calculated upon user registration. Instead, it typically depends on one or more of the following trigger events:

### 🔁 Common Referral Bonus Triggers:
1. **First Deposit or Purchase** <br/>
   ➤ Referral bonus is awarded when the new user (referee) makes their first qualifying deposit or purchase.

2. **Activation of Account** <br/>
   ➤ Some MLM systems require users to activate their accounts via payment or product purchase before the bonus is triggered.

3. **Completing a Minimum Requirement** <br/>
   ➤ Bonus is given only after the referee meets certain conditions (e.g. reaching a rank, inviting others, etc.).

4. **Manual Approval** <br/>
   ➤ In more controlled systems, referral bonuses are awarded manually after verification.

### ❌ Not Typical:
Awarding referral bonus immediately after registration can lead to abuse and fake account creation, which is why most MLM platforms delay the bonus until some genuine engagement (like a payment or deposit) is done.

### ✅ Best Practice:
Trigger referral bonus after successful [business volume (BV)](README-business_value.md) is generated by the referred user. For example:
````java
if (refereeMadeDeposit) {
    calculateAndDistributeReferralBonus(referrerId, depositAmount);
}
````



## ✅ Step-by-Step Referral Bonus Strategy Implementation

### 1. Define an Interface
````java
public interface ReferralBonusStrategy {
    boolean isEligible(User referee);
    void applyBonus(User referrer, User referee);
}
````

### 2.1. First Deposit or Purchase Strategy
````java
@Component("firstDeposit")
public class FirstDepositBonusStrategy implements ReferralBonusStrategy {

    @Override
    public boolean isEligible(User referee) {
        return referee.getDeposits().size() == 1; // first deposit
    }

    @Override
    public void applyBonus(User referrer, User referee) {
        // Apply bonus to referrer
    }
}

````

### 2.2. Account Activation Strategy
````java
@Component("accountActivation")
public class AccountActivationBonusStrategy implements ReferralBonusStrategy {

    @Override
    public boolean isEligible(User referee) {
        return referee.isActivated();
    }

    @Override
    public void applyBonus(User referrer, User referee) {
        // Apply bonus logic
    }
}
````


### 2.3. Minimum Requirement Strategy
````java
@Component("minRequirement")
public class MinimumRequirementBonusStrategy implements ReferralBonusStrategy {

    @Override
    public boolean isEligible(User referee) {
        return referee.getRank() >= Rank.BRONZE; // or check invites etc.
    }

    @Override
    public void applyBonus(User referrer, User referee) {
        // Apply bonus
    }
}
````


### 2.4. Manual Approval Strategy
````java
@Component("manualApproval")
public class ManualApprovalBonusStrategy implements ReferralBonusStrategy {

    @Override
    public boolean isEligible(User referee) {
        return referee.isReferralApproved(); // or similar admin-flag
    }

    @Override
    public void applyBonus(User referrer, User referee) {
        // Admin manually triggers this, so logic may be minimal
    }
}
````

## 3. Strategy Selector
````java
@Service
public class ReferralBonusService {

    private final Map<String, ReferralBonusStrategy> strategies;

    @Autowired
    public ReferralBonusService(List<ReferralBonusStrategy> strategyList) {
        this.strategies = strategyList.stream()
            .collect(Collectors.toMap(s -> s.getClass().getAnnotation(Component.class).value(), s -> s));
    }

    public void evaluateBonus(User referrer, User referee, String strategyKey) {
        ReferralBonusStrategy strategy = strategies.get(strategyKey);
        if (strategy != null && strategy.isEligible(referee)) {
            strategy.applyBonus(referrer, referee);
        }
    }
}
````

## 4. Usage
````java
referralBonusService.evaluateBonus(referrer, referee, "firstDeposit");
````

````java
String strategyKey = systemConfig.getReferralBonusStrategy(); // e.g., "accountActivation"
referralBonusService.evaluateBonus(referrer, referee, strategyKey);
````

---

## Triggering point of the `referralBonusService` call:
The `ReferralBonusService` should be triggered **after the event that qualifies a user for a referral bonus**, depending on the strategy you're using.

### ✅ 1. After First Deposit or Purchase
Trigger in your deposit/purchase service:
````java
public void handleDeposit(Long userId, double amount) {
    User user = userRepository.findById(userId).orElseThrow();
    depositRepository.save(new Deposit(...));

    // Assuming deposit count = 1 implies first deposit
    if (user.getDeposits().size() == 1) {
        User referrer = user.getReferrer();
        referralBonusService.evaluateBonus(referrer, user, "firstDeposit");
    }
}
````

### ✅ 2. After Account Activation
Trigger after activation logic:
````java
public void activateAccount(Long userId) {
    User user = userRepository.findById(userId).orElseThrow();
    user.setActivated(true);
    userRepository.save(user);

    if (user.getReferrer() != null) {
        referralBonusService.evaluateBonus(user.getReferrer(), user, "accountActivation");
    }
}
````

### ✅ 3. After Completing Minimum Requirements
````java
public void checkMinimumRequirements(User user) {
    if (user.qualifiesForBonus()) {
        User referrer = user.getReferrer();
        referralBonusService.evaluateBonus(referrer, user, "minRequirement");
    }
}
````

### ✅ 4. Manual Approval
````java
public void approveReferralBonus(Long userId) {
    User user = userRepository.findById(userId).orElseThrow();
    user.setReferralApproved(true);
    userRepository.save(user);

    referralBonusService.evaluateBonus(user.getReferrer(), user, "manualApproval");
}
````

## 🔁 Optional: Use Event Listener for Decoupling
For better separation of concerns, you could use **Spring Events** to trigger **ReferralBonusService** in response to specific user actions (e.g., deposit, activation, etc.).

### ✅ 1. Define a Custom Event
````java
public class ReferralBonusEvent extends ApplicationEvent {
    private final User referrer;
    private final User referee;
    private final String triggerType; // e.g., "firstDeposit", "activation"

    public ReferralBonusEvent(Object source, User referrer, User referee, String triggerType) {
        super(source);
        this.referrer = referrer;
        this.referee = referee;
        this.triggerType = triggerType;
    }

    public User getReferrer() { return referrer; }
    public User getReferee() { return referee; }
    public String getTriggerType() { return triggerType; }
}
````

### ✅ 2. Publish the Event
From any service (like deposit or activation), you publish it via `ApplicationEventPublisher`:
````java
@Service
@RequiredArgsConstructor
public class DepositService {
    private final ApplicationEventPublisher eventPublisher;
    private final UserRepository userRepository;
    private final DepositRepository depositRepository;

    public void deposit(Long userId, double amount) {
        User user = userRepository.findById(userId).orElseThrow();
        depositRepository.save(new Deposit(...));

        if (user.getDeposits().size() == 1 && user.getReferrer() != null) {
            eventPublisher.publishEvent(new ReferralBonusEvent(this, user.getReferrer(), user, "firstDeposit"));
        }
    }
}
````

### ✅ 3. Listen for the Event
````java
@Component
public class ReferralBonusEventListener {

    private final ReferralBonusService referralBonusService;

    public ReferralBonusEventListener(ReferralBonusService referralBonusService) {
        this.referralBonusService = referralBonusService;
    }

    @EventListener
    public void onReferralBonusEvent(ReferralBonusEvent event) {
        referralBonusService.evaluateBonus(event.getReferrer(), event.getReferee(), event.getTriggerType());
    }
}
````

## 🕒 Optional: Schedule Deferred Bonus Evaluation
If bonuses are delayed (e.g., check if user meets conditions later), use a **scheduled task**:

### ➤ 1. Enable scheduling
````java
@SpringBootApplication
@EnableScheduling
public class App {
    public static void main(String[] args) {
        SpringApplication.run(App.class, args);
    }
}
````

### ➤ 2. Add a Scheduled Bonus Checker
````java
@Component
@RequiredArgsConstructor
public class ReferralBonusScheduler {
    private final UserRepository userRepository;
    private final ReferralBonusService referralBonusService;

    @Scheduled(fixedRate = 60000) // every 60 seconds
    public void evaluateDeferredBonuses() {
        List<User> eligibleUsers = userRepository.findUsersWaitingForBonus();

        for (User user : eligibleUsers) {
            if (user.meetsBonusConditions()) {
                referralBonusService.evaluateBonus(user.getReferrer(), user, "deferredCheck");
            }
        }
    }
}   
````

### ✅ Summary

| Feature                    | Approach           |
| -------------------------- | ------------------ |
| Decouple triggering logic  | `ApplicationEvent` |
| Centralized bonus handling | `@EventListener`   |
| Delay bonuses if needed    | `@Scheduled` tasks |


## ✅ Project Structure

````csharp
referral-bonus/
├── ReferralBonusApplication.java
├── controller/
│   └── UserController.java
├── dto/
│   └── UserRegistrationEvent.java
├── event/
│   └── UserRegisteredEvent.java
├── listener/
│   └── ReferralBonusListener.java
├── model/
│   └── User.java
├── repository/
│   └── UserRepository.java
├── service/
│   ├── BonusService.java
│   └── UserService.java
└── scheduler/
    └── BonusEvaluator.java
````

## 🚀 Key Components

1. UserRegisteredEvent.java
    ````java
    public class UserRegisteredEvent extends ApplicationEvent {
        private final Long userId;
    
        public UserRegisteredEvent(Object source, Long userId) {
            super(source);
            this.userId = userId;
        }
    
        public Long getUserId() {
            return userId;
        }
    }
    ````

2. ReferralBonusListener.java
    ````java
    @Component
    public class ReferralBonusListener {
    
        private final BonusService bonusService;
    
        public ReferralBonusListener(BonusService bonusService) {
            this.bonusService = bonusService;
        }
    
        @EventListener
        public void handleUserRegistered(UserRegisteredEvent event) {
            bonusService.evaluateReferralBonus(event.getUserId());
        }
    }
    ````

3. UserService.java
    ````java
    @Service
    public class UserService {
    
        private final ApplicationEventPublisher publisher;
    
        public UserService(ApplicationEventPublisher publisher) {
            this.publisher = publisher;
        }
    
        public void registerUser(User user) {
            // Save logic...
            publisher.publishEvent(new UserRegisteredEvent(this, user.getId()));
        }
    }
    ````
4. BonusEvaluator.java (Scheduled Check)
    ````java
    @Component
    public class BonusEvaluator {
    
        private final BonusService bonusService;
    
        public BonusEvaluator(BonusService bonusService) {
            this.bonusService = bonusService;
        }
    
        @Scheduled(fixedRate = 86400000) // every 24 hours
        public void checkAndApplyBonuses() {
            bonusService.evaluateAllPendingBonuses();
        }
    }
    ````